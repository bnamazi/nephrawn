generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// Slice 1: Foundation Entities
// ============================================

model Patient {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  name         String
  dateOfBirth  DateTime @db.Date
  preferences  Json     @default("{}")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  enrollments      Enrollment[]
  interactionLogs  InteractionLog[]
  symptomCheckins  SymptomCheckin[]
  measurements     Measurement[]
  alerts           Alert[]
  clinicianNotes   ClinicianNote[]
  claimedInvites   Invite[]         @relation("InvitesClaimed")

  @@map("patients")
}

model Clinician {
  id           String        @id @default(uuid())
  email        String        @unique
  passwordHash String
  name         String
  role         ClinicianRole @default(CLINICIAN)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  enrollments        Enrollment[]
  interactionLogs    InteractionLog[]
  acknowledgedAlerts Alert[]
  clinicianNotes     ClinicianNote[]
  clinicMemberships  ClinicMembership[]
  createdInvites     Invite[]           @relation("InvitesCreated")

  @@map("clinicians")
}

enum ClinicianRole {
  CLINICIAN
  ADMIN
}

// ============================================
// Clinic & Enrollment Entities
// ============================================

model Clinic {
  id        String       @id @default(uuid())
  name      String
  slug      String       @unique // URL-safe identifier
  npi       String?      @unique // National Provider Identifier
  address   Json?        // Structured address
  phone     String?
  status    ClinicStatus @default(ACTIVE)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  memberships ClinicMembership[]
  enrollments Enrollment[]
  invites     Invite[]

  @@index([status])
  @@map("clinics")
}

enum ClinicStatus {
  ACTIVE
  SUSPENDED
}

model ClinicMembership {
  id          String                 @id @default(uuid())
  clinicId    String
  clinicianId String
  role        ClinicMembershipRole   @default(CLINICIAN)
  status      ClinicMembershipStatus @default(ACTIVE)
  joinedAt    DateTime               @default(now())
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt

  clinic    Clinic    @relation(fields: [clinicId], references: [id])
  clinician Clinician @relation(fields: [clinicianId], references: [id])

  @@unique([clinicId, clinicianId])
  @@index([clinicianId, status])
  @@map("clinic_memberships")
}

enum ClinicMembershipRole {
  OWNER
  ADMIN
  CLINICIAN
  STAFF
}

enum ClinicMembershipStatus {
  ACTIVE
  INACTIVE
}

model Invite {
  id           String       @id @default(uuid())
  code         String       @unique @db.VarChar(40) // Cryptographic random code
  clinicId     String
  createdById  String
  patientName  String
  patientDob   DateTime     @db.Date // For identity verification
  patientEmail String?      // Optional: for notification
  status       InviteStatus @default(PENDING)
  expiresAt    DateTime     // Default: 7 days from creation
  claimedById  String?      // Patient who claimed
  claimedAt    DateTime?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  clinic    Clinic     @relation(fields: [clinicId], references: [id])
  createdBy Clinician  @relation("InvitesCreated", fields: [createdById], references: [id])
  claimedBy Patient?   @relation("InvitesClaimed", fields: [claimedById], references: [id])

  enrollments Enrollment[]

  @@index([status, expiresAt])
  @@index([clinicId, status])
  @@map("invites")
}

enum InviteStatus {
  PENDING
  CLAIMED
  EXPIRED
  REVOKED
}

model Enrollment {
  id           String           @id @default(uuid())
  patientId    String
  clinicianId  String
  clinicId     String
  status       EnrollmentStatus @default(ACTIVE)
  isPrimary    Boolean          @default(true)
  enrolledVia  EnrolledVia      @default(INVITE)
  inviteId     String?          // FK to Invite if enrolled via invite
  enrolledAt   DateTime         @default(now())
  dischargedAt DateTime?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  patient   Patient   @relation(fields: [patientId], references: [id])
  clinician Clinician @relation(fields: [clinicianId], references: [id])
  clinic    Clinic    @relation(fields: [clinicId], references: [id])
  invite    Invite?   @relation(fields: [inviteId], references: [id])

  @@unique([patientId, clinicianId, clinicId])
  @@index([clinicianId, clinicId, status])
  @@index([patientId, clinicId])
  @@map("enrollments")
}

enum EnrolledVia {
  INVITE
  MIGRATION
  ADMIN
}

enum EnrollmentStatus {
  ACTIVE
  PAUSED
  DISCHARGED
}

model InteractionLog {
  id              String          @id @default(uuid())
  patientId       String
  clinicianId     String?
  timestamp       DateTime        @default(now())
  interactionType InteractionType
  durationSeconds Int?
  metadata        Json            @default("{}")
  createdAt       DateTime        @default(now())

  patient   Patient    @relation(fields: [patientId], references: [id])
  clinician Clinician? @relation(fields: [clinicianId], references: [id])

  @@index([patientId, timestamp])
  @@index([clinicianId, timestamp])
  @@map("interaction_logs")
}

enum InteractionType {
  PATIENT_CHECKIN
  PATIENT_MEASUREMENT
  CLINICIAN_VIEW
  CLINICIAN_ALERT_ACK
  CLINICIAN_NOTE
  CLINICIAN_CALL
  CLINICIAN_MESSAGE
}

// ============================================
// Slice 2: Symptom Check-ins
// ============================================

model SymptomCheckin {
  id        String   @id @default(uuid())
  patientId String
  timestamp DateTime @default(now())
  symptoms  Json
  notes     String?
  createdAt DateTime @default(now())

  patient Patient @relation(fields: [patientId], references: [id])

  @@index([patientId, timestamp])
  @@map("symptom_checkins")
}

// ============================================
// Slice 3: Measurements & Alerts
// ============================================

model Measurement {
  id         String          @id @default(uuid())
  patientId  String
  timestamp  DateTime        @default(now())
  type       MeasurementType
  value      Decimal         @db.Decimal(10, 2)
  unit       String          // Always stored in canonical units (kg, mmHg, %, bpm)
  inputUnit  String?         // Original unit submitted by user/device
  source     String          @default("manual") // manual, withings, etc.
  externalId String?         // vendor's record ID for dedup
  createdAt  DateTime        @default(now())

  patient Patient @relation(fields: [patientId], references: [id])

  @@unique([source, externalId], name: "device_dedup") // Prevent device duplicates
  @@index([patientId, type, timestamp])
  @@index([patientId, type, source, timestamp]) // For manual dedup window check
  @@map("measurements")
}

enum MeasurementType {
  WEIGHT
  BP_SYSTOLIC
  BP_DIASTOLIC
  SPO2
  HEART_RATE
}

model Alert {
  id             String        @id @default(uuid())
  patientId      String
  triggeredAt    DateTime      @default(now())
  ruleId         String        // e.g., 'weight_gain_48h'
  ruleName       String        // Human-readable name
  severity       AlertSeverity
  status         AlertStatus   @default(OPEN)
  inputs         Json          // Data that triggered the alert (explainability)
  summaryText    String?       // LLM-generated explanation (nullable)
  acknowledgedBy String?
  acknowledgedAt DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  patient        Patient         @relation(fields: [patientId], references: [id])
  clinician      Clinician?      @relation(fields: [acknowledgedBy], references: [id])
  clinicianNotes ClinicianNote[]

  @@index([patientId, status, triggeredAt])
  @@map("alerts")
}

enum AlertSeverity {
  INFO
  WARNING
  CRITICAL
}

enum AlertStatus {
  OPEN
  ACKNOWLEDGED
  DISMISSED
}

// ============================================
// Slice 4: Clinician Notes
// ============================================

model ClinicianNote {
  id          String   @id @default(uuid())
  patientId   String
  clinicianId String
  alertId     String?  // Optional: attach note to a specific alert
  content     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  patient   Patient   @relation(fields: [patientId], references: [id])
  clinician Clinician @relation(fields: [clinicianId], references: [id])
  alert     Alert?    @relation(fields: [alertId], references: [id])

  @@index([patientId, createdAt])
  @@index([alertId])
  @@map("clinician_notes")
}
