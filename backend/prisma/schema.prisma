generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// Slice 1: Foundation Entities
// ============================================

model Patient {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  name         String
  dateOfBirth  DateTime @db.Date
  preferences  Json     @default("{}")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  enrollments      Enrollment[]
  interactionLogs  InteractionLog[]
  symptomCheckins  SymptomCheckin[]
  measurements     Measurement[]
  alerts           Alert[]
  clinicianNotes   ClinicianNote[]

  @@map("patients")
}

model Clinician {
  id           String        @id @default(uuid())
  email        String        @unique
  passwordHash String
  name         String
  role         ClinicianRole @default(CLINICIAN)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  enrollments        Enrollment[]
  interactionLogs    InteractionLog[]
  acknowledgedAlerts Alert[]
  clinicianNotes     ClinicianNote[]

  @@map("clinicians")
}

enum ClinicianRole {
  CLINICIAN
  ADMIN
}

model Enrollment {
  id           String           @id @default(uuid())
  patientId    String
  clinicianId  String
  status       EnrollmentStatus @default(ACTIVE)
  isPrimary    Boolean          @default(true)
  enrolledAt   DateTime         @default(now())
  dischargedAt DateTime?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  patient   Patient   @relation(fields: [patientId], references: [id])
  clinician Clinician @relation(fields: [clinicianId], references: [id])

  @@unique([patientId, clinicianId])
  @@index([clinicianId, status])
  @@map("enrollments")
}

enum EnrollmentStatus {
  ACTIVE
  PAUSED
  DISCHARGED
}

model InteractionLog {
  id              String          @id @default(uuid())
  patientId       String
  clinicianId     String?
  timestamp       DateTime        @default(now())
  interactionType InteractionType
  durationSeconds Int?
  metadata        Json            @default("{}")
  createdAt       DateTime        @default(now())

  patient   Patient    @relation(fields: [patientId], references: [id])
  clinician Clinician? @relation(fields: [clinicianId], references: [id])

  @@index([patientId, timestamp])
  @@index([clinicianId, timestamp])
  @@map("interaction_logs")
}

enum InteractionType {
  PATIENT_CHECKIN
  PATIENT_MEASUREMENT
  CLINICIAN_VIEW
  CLINICIAN_ALERT_ACK
  CLINICIAN_NOTE
  CLINICIAN_CALL
  CLINICIAN_MESSAGE
}

// ============================================
// Slice 2: Symptom Check-ins
// ============================================

model SymptomCheckin {
  id        String   @id @default(uuid())
  patientId String
  timestamp DateTime @default(now())
  symptoms  Json
  notes     String?
  createdAt DateTime @default(now())

  patient Patient @relation(fields: [patientId], references: [id])

  @@index([patientId, timestamp])
  @@map("symptom_checkins")
}

// ============================================
// Slice 3: Measurements & Alerts
// ============================================

model Measurement {
  id         String          @id @default(uuid())
  patientId  String
  timestamp  DateTime        @default(now())
  type       MeasurementType
  value      Decimal         @db.Decimal(10, 2)
  unit       String          // Always stored in canonical units (kg, mmHg, %, bpm)
  inputUnit  String?         // Original unit submitted by user/device
  source     String          @default("manual") // manual, withings, etc.
  externalId String?         // vendor's record ID for dedup
  createdAt  DateTime        @default(now())

  patient Patient @relation(fields: [patientId], references: [id])

  @@unique([source, externalId], name: "device_dedup") // Prevent device duplicates
  @@index([patientId, type, timestamp])
  @@index([patientId, type, source, timestamp]) // For manual dedup window check
  @@map("measurements")
}

enum MeasurementType {
  WEIGHT
  BP_SYSTOLIC
  BP_DIASTOLIC
  SPO2
  HEART_RATE
}

model Alert {
  id             String        @id @default(uuid())
  patientId      String
  triggeredAt    DateTime      @default(now())
  ruleId         String        // e.g., 'weight_gain_48h'
  ruleName       String        // Human-readable name
  severity       AlertSeverity
  status         AlertStatus   @default(OPEN)
  inputs         Json          // Data that triggered the alert (explainability)
  summaryText    String?       // LLM-generated explanation (nullable)
  acknowledgedBy String?
  acknowledgedAt DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  patient        Patient         @relation(fields: [patientId], references: [id])
  clinician      Clinician?      @relation(fields: [acknowledgedBy], references: [id])
  clinicianNotes ClinicianNote[]

  @@index([patientId, status, triggeredAt])
  @@map("alerts")
}

enum AlertSeverity {
  INFO
  WARNING
  CRITICAL
}

enum AlertStatus {
  OPEN
  ACKNOWLEDGED
  DISMISSED
}

// ============================================
// Slice 4: Clinician Notes
// ============================================

model ClinicianNote {
  id          String   @id @default(uuid())
  patientId   String
  clinicianId String
  alertId     String?  // Optional: attach note to a specific alert
  content     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  patient   Patient   @relation(fields: [patientId], references: [id])
  clinician Clinician @relation(fields: [clinicianId], references: [id])
  alert     Alert?    @relation(fields: [alertId], references: [id])

  @@index([patientId, createdAt])
  @@index([alertId])
  @@map("clinician_notes")
}
