generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// Slice 1: Foundation Entities
// ============================================

model Patient {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  name         String
  dateOfBirth  DateTime @db.Date
  preferences  Json     @default("{}")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  enrollments           Enrollment[]
  interactionLogs       InteractionLog[]
  symptomCheckins       SymptomCheckin[]
  measurements          Measurement[]
  alerts                Alert[]
  clinicianNotes        ClinicianNote[]
  claimedInvites        Invite[]              @relation("InvitesClaimed")
  profile               PatientProfile?
  profileAudits         PatientProfileAudit[]
  medications           Medication[]
  documents             Document[]
  labReports            LabReport[]
  deviceConnections     DeviceConnection[]
  timeEntries           TimeEntry[]

  @@map("patients")
}

model Clinician {
  id           String        @id @default(uuid())
  email        String        @unique
  passwordHash String
  name         String
  role         ClinicianRole @default(CLINICIAN)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  enrollments          Enrollment[]
  interactionLogs      InteractionLog[]
  acknowledgedAlerts   Alert[]
  clinicianNotes       ClinicianNote[]
  clinicMemberships    ClinicMembership[]
  createdInvites       Invite[]           @relation("InvitesCreated")
  verifiedLabReports   LabReport[]
  timeEntries          TimeEntry[]

  @@map("clinicians")
}

enum ClinicianRole {
  CLINICIAN
  ADMIN
}

// ============================================
// Clinic & Enrollment Entities
// ============================================

model Clinic {
  id        String       @id @default(uuid())
  name      String
  slug      String       @unique // URL-safe identifier
  npi       String?      @unique // National Provider Identifier
  taxId     String?      // EIN for billing
  address   Json?        // Structured address
  phone     String?
  fax       String?
  email     String?      // Clinic contact email
  website   String?
  timezone  String       @default("America/New_York")
  settings  Json?        // Additional configurable settings
  status    ClinicStatus @default(ACTIVE)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  memberships ClinicMembership[]
  enrollments Enrollment[]
  invites     Invite[]
  timeEntries TimeEntry[]

  @@index([status])
  @@map("clinics")
}

enum ClinicStatus {
  ACTIVE
  SUSPENDED
}

model ClinicMembership {
  id          String                 @id @default(uuid())
  clinicId    String
  clinicianId String
  role        ClinicMembershipRole   @default(CLINICIAN)
  status      ClinicMembershipStatus @default(ACTIVE)
  joinedAt    DateTime               @default(now())
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt

  clinic    Clinic    @relation(fields: [clinicId], references: [id])
  clinician Clinician @relation(fields: [clinicianId], references: [id])

  @@unique([clinicId, clinicianId])
  @@index([clinicianId, status])
  @@map("clinic_memberships")
}

enum ClinicMembershipRole {
  OWNER
  ADMIN
  CLINICIAN
  STAFF
}

enum ClinicMembershipStatus {
  ACTIVE
  INACTIVE
}

model Invite {
  id           String       @id @default(uuid())
  code         String       @unique @db.VarChar(40) // Cryptographic random code
  clinicId     String
  createdById  String
  patientName  String
  patientDob   DateTime     @db.Date // For identity verification
  patientEmail String?      // Optional: for notification
  status       InviteStatus @default(PENDING)
  expiresAt    DateTime     // Default: 7 days from creation
  claimedById  String?      // Patient who claimed
  claimedAt    DateTime?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  clinic    Clinic     @relation(fields: [clinicId], references: [id])
  createdBy Clinician  @relation("InvitesCreated", fields: [createdById], references: [id])
  claimedBy Patient?   @relation("InvitesClaimed", fields: [claimedById], references: [id])

  enrollments Enrollment[]

  @@index([status, expiresAt])
  @@index([clinicId, status])
  @@map("invites")
}

enum InviteStatus {
  PENDING
  CLAIMED
  EXPIRED
  REVOKED
}

model Enrollment {
  id           String           @id @default(uuid())
  patientId    String
  clinicianId  String
  clinicId     String
  status       EnrollmentStatus @default(ACTIVE)
  isPrimary    Boolean          @default(true)
  enrolledVia  EnrolledVia      @default(INVITE)
  inviteId     String?          // FK to Invite if enrolled via invite
  enrolledAt   DateTime         @default(now())
  dischargedAt DateTime?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  patient   Patient   @relation(fields: [patientId], references: [id])
  clinician Clinician @relation(fields: [clinicianId], references: [id])
  clinic    Clinic    @relation(fields: [clinicId], references: [id])
  invite    Invite?   @relation(fields: [inviteId], references: [id])
  carePlan  CarePlan?

  @@unique([patientId, clinicianId, clinicId])
  @@index([clinicianId, clinicId, status])
  @@index([patientId, clinicId])
  @@map("enrollments")
}

enum EnrolledVia {
  INVITE
  MIGRATION
  ADMIN
}

enum EnrollmentStatus {
  ACTIVE
  PAUSED
  DISCHARGED
}

model InteractionLog {
  id              String          @id @default(uuid())
  patientId       String
  clinicianId     String?
  timestamp       DateTime        @default(now())
  interactionType InteractionType
  durationSeconds Int?
  metadata        Json            @default("{}")
  createdAt       DateTime        @default(now())

  patient   Patient    @relation(fields: [patientId], references: [id])
  clinician Clinician? @relation(fields: [clinicianId], references: [id])

  @@index([patientId, timestamp])
  @@index([clinicianId, timestamp])
  @@map("interaction_logs")
}

enum InteractionType {
  PATIENT_CHECKIN
  PATIENT_MEASUREMENT
  PATIENT_MEDICATION
  PATIENT_ADHERENCE_LOG
  PATIENT_DOCUMENT
  PATIENT_LAB_REPORT
  CLINICIAN_VIEW
  CLINICIAN_ALERT_ACK
  CLINICIAN_NOTE
  CLINICIAN_CALL
  CLINICIAN_MESSAGE
  CLINICIAN_MEDICATION_VIEW
  CLINICIAN_DOCUMENT_VIEW
  CLINICIAN_LAB_VIEW
  CLINICIAN_LAB_VERIFY
  CLINICIAN_LAB_CREATE
}

// ============================================
// Slice 2: Symptom Check-ins
// ============================================

model SymptomCheckin {
  id        String   @id @default(uuid())
  patientId String
  timestamp DateTime @default(now())
  symptoms  Json
  notes     String?
  createdAt DateTime @default(now())

  patient Patient @relation(fields: [patientId], references: [id])

  @@index([patientId, timestamp])
  @@map("symptom_checkins")
}

// ============================================
// Slice 3: Measurements & Alerts
// ============================================

model Measurement {
  id         String          @id @default(uuid())
  patientId  String
  timestamp  DateTime        @default(now())
  type       MeasurementType
  value      Decimal         @db.Decimal(10, 2)
  unit       String          // Always stored in canonical units (kg, mmHg, %, bpm)
  inputUnit  String?         // Original unit submitted by user/device
  source     String          @default("manual") // manual, withings, etc.
  externalId String?         // vendor's record ID for dedup
  createdAt  DateTime        @default(now())

  patient Patient @relation(fields: [patientId], references: [id])

  @@unique([source, externalId], name: "device_dedup") // Prevent device duplicates
  @@index([patientId, type, timestamp])
  @@index([patientId, type, source, timestamp]) // For manual dedup window check
  @@map("measurements")
}

enum MeasurementType {
  WEIGHT
  BP_SYSTOLIC
  BP_DIASTOLIC
  SPO2
  HEART_RATE
  // Body composition types (Withings Body Pro 2)
  FAT_FREE_MASS       // kg - Lean mass
  FAT_RATIO           // % - Body fat percentage
  FAT_MASS            // kg - Fat mass weight
  MUSCLE_MASS         // kg
  HYDRATION           // kg - Body water
  BONE_MASS           // kg
  PULSE_WAVE_VELOCITY // m/s - Vascular age indicator
}

model Alert {
  id             String        @id @default(uuid())
  patientId      String
  triggeredAt    DateTime      @default(now())
  ruleId         String        // e.g., 'weight_gain_48h'
  ruleName       String        // Human-readable name
  severity       AlertSeverity
  status         AlertStatus   @default(OPEN)
  inputs         Json          // Data that triggered the alert (explainability)
  summaryText    String?       // LLM-generated explanation (nullable)
  acknowledgedBy String?
  acknowledgedAt DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  patient        Patient         @relation(fields: [patientId], references: [id])
  clinician      Clinician?      @relation(fields: [acknowledgedBy], references: [id])
  clinicianNotes ClinicianNote[]

  @@index([patientId, status, triggeredAt])
  @@map("alerts")
}

enum AlertSeverity {
  INFO
  WARNING
  CRITICAL
}

enum AlertStatus {
  OPEN
  ACKNOWLEDGED
  DISMISSED
}

// ============================================
// Slice 4: Clinician Notes
// ============================================

model ClinicianNote {
  id          String   @id @default(uuid())
  patientId   String
  clinicianId String
  alertId     String?  // Optional: attach note to a specific alert
  content     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  patient   Patient   @relation(fields: [patientId], references: [id])
  clinician Clinician @relation(fields: [clinicianId], references: [id])
  alert     Alert?    @relation(fields: [alertId], references: [id])

  @@index([patientId, createdAt])
  @@index([alertId])
  @@map("clinician_notes")
}

// ============================================
// Slice 6: Medication Tracking
// ============================================

model Medication {
  id           String   @id @default(uuid())
  patientId    String
  patient      Patient  @relation(fields: [patientId], references: [id])

  name         String
  dosage       String?
  frequency    String?
  instructions String?
  startDate    DateTime?
  endDate      DateTime?
  isActive     Boolean  @default(true)

  // Discontinuation tracking
  discontinuedAt     DateTime?
  discontinuedById   String?
  discontinuedReason String?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  logs         MedicationLog[]

  @@index([patientId, isActive])
  @@map("medications")
}

model MedicationLog {
  id           String     @id @default(uuid())
  medicationId String
  medication   Medication @relation(fields: [medicationId], references: [id])

  loggedAt     DateTime   @default(now())
  scheduledFor DateTime?
  taken        Boolean
  notes        String?

  createdAt    DateTime   @default(now())

  @@index([medicationId, loggedAt])
  @@map("medication_logs")
}

// ============================================
// Slice 7: Lab Result Uploads
// ============================================

enum DocumentType {
  LAB_RESULT
  OTHER
}

model Document {
  id           String       @id @default(uuid())
  patientId    String
  patient      Patient      @relation(fields: [patientId], references: [id])

  type         DocumentType @default(LAB_RESULT)
  filename     String                        // original filename
  mimeType     String                        // e.g., "application/pdf", "image/jpeg"
  sizeBytes    Int
  storageKey   String       @unique          // path in storage

  title        String?                       // patient-provided title
  notes        String?                       // patient-provided notes
  documentDate DateTime?                     // date on the lab report

  uploadedAt   DateTime     @default(now())
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  labReports   LabReport[]                   // Structured lab data extracted from this document

  @@index([patientId, uploadedAt])
  @@index([patientId, type])
  @@map("documents")
}

// ============================================
// Slice 2.5: Structured Lab Results
// ============================================

enum LabSource {
  MANUAL_PATIENT
  MANUAL_CLINICIAN
  IMPORTED
}

enum LabResultFlag {
  H   // High
  L   // Low
  C   // Critical
}

model LabReport {
  id               String      @id @default(uuid())
  patientId        String
  patient          Patient     @relation(fields: [patientId], references: [id])

  documentId       String?                     // Optional link to source PDF
  document         Document?   @relation(fields: [documentId], references: [id])

  collectedAt      DateTime                    // Date/time of blood draw
  reportedAt       DateTime?                   // Date lab reported results
  labName          String?                     // e.g., "Quest Diagnostics"
  orderingProvider String?
  notes            String?

  source           LabSource   @default(MANUAL_PATIENT)

  verifiedAt       DateTime?
  verifiedById     String?
  verifiedBy       Clinician?  @relation(fields: [verifiedById], references: [id])

  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  results          LabResult[]

  @@index([patientId, collectedAt])
  @@index([documentId])
  @@map("lab_reports")
}

model LabResult {
  id                 String         @id @default(uuid())
  reportId           String
  report             LabReport      @relation(fields: [reportId], references: [id], onDelete: Cascade)

  analyteCode        String?                   // LOINC code (for future standardization)
  analyteName        String                    // Display name

  value              Decimal        @db.Decimal(10, 4)
  unit               String

  referenceRangeLow  Decimal?       @db.Decimal(10, 4)
  referenceRangeHigh Decimal?       @db.Decimal(10, 4)
  flag               LabResultFlag?

  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt

  @@unique([reportId, analyteName])
  @@index([reportId])
  @@map("lab_results")
}

// ============================================
// Audit Trail
// ============================================

model AuditLog {
  id           String   @id @default(uuid())
  action       String   // e.g., 'invite.created', 'invite.revoked', 'enrollment.created'
  actorType    String   // 'clinician', 'patient', 'system'
  actorId      String?  // ID of the actor (null for system actions)
  resourceType String   // 'invite', 'enrollment', 'clinic', etc.
  resourceId   String   // ID of the affected resource
  metadata     Json     @default("{}") // Additional context
  ipAddress    String?  // For security auditing
  userAgent    String?  // For security auditing
  createdAt    DateTime @default(now())

  @@index([action, createdAt])
  @@index([actorType, actorId, createdAt])
  @@index([resourceType, resourceId, createdAt])
  @@map("audit_logs")
}

// ============================================
// Slice 5: Patient Profile & Care Plan
// ============================================

model PatientProfile {
  id        String  @id @default(uuid())
  patientId String  @unique
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  // Demographics
  sex      Sex?
  heightCm Decimal? @db.Decimal(5, 1)

  // CKD Context - Dual source for safety
  ckdStageSelfReported CkdStage?
  ckdStageClinician    CkdStage?
  ckdStageSetById      String?   // Clinician who set ckdStageClinician
  ckdStageSetAt        DateTime?

  primaryEtiology   KidneyDiseaseEtiology?
  dialysisStatus    DialysisStatus         @default(NONE)
  dialysisStartDate DateTime?              @db.Date
  transplantStatus  TransplantStatus       @default(NONE)
  transplantDate    DateTime?              @db.Date

  // Comorbidities
  hasHeartFailure   Boolean      @default(false)
  heartFailureClass NyhaClass?
  diabetesType      DiabetesType @default(NONE)
  hasHypertension   Boolean      @default(false)
  otherConditions   Json?        // string[]

  // Medication Context (categories only, not full reconciliation)
  onDiuretics       Boolean @default(false)
  onAceArbInhibitor Boolean @default(false)
  onSglt2Inhibitor  Boolean @default(false)
  onNsaids          Boolean @default(false)
  onMra             Boolean @default(false)
  onInsulin         Boolean @default(false)
  medicationNotes   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("patient_profiles")
}

model CarePlan {
  id           String     @id @default(uuid())
  enrollmentId String     @unique
  enrollment   Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  // Weight Target
  dryWeightKg Decimal? @db.Decimal(5, 2)

  // BP Targets (structured ranges: { min: number, max: number })
  targetBpSystolic  Json?
  targetBpDiastolic Json?

  // Risk Assessment
  priorHfHospitalizations Int     @default(0)
  fluidRetentionRisk      Boolean @default(false)
  fallsRisk               Boolean @default(false)

  // Notes
  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("care_plans")
}

model PatientProfileAudit {
  id        String @id @default(uuid())
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  // What was changed
  entityType AuditEntityType
  entityId   String // profile.id or carePlan.id

  // Who changed it
  actorType ActorType
  actorId   String // patient.id or clinician.id
  actorName String // Denormalized for display

  // What changed
  changedFields Json    // { fieldName: { old: value, new: value } }
  reason        String? // Optional explanation

  timestamp DateTime @default(now())

  @@index([patientId, timestamp])
  @@index([entityType, entityId, timestamp])
  @@index([actorId, actorType])
  @@map("patient_profile_audits")
}

// ============================================
// Patient History Enums
// ============================================

enum Sex {
  MALE
  FEMALE
  OTHER
  UNKNOWN
}

enum CkdStage {
  STAGE_1
  STAGE_2
  STAGE_3A
  STAGE_3B
  STAGE_4
  STAGE_5
  STAGE_5D    // On dialysis
  TRANSPLANT
  UNKNOWN
}

enum KidneyDiseaseEtiology {
  DIABETES
  HYPERTENSION
  GLOMERULONEPHRITIS
  POLYCYSTIC
  OBSTRUCTIVE
  OTHER
  UNKNOWN
}

enum DialysisStatus {
  NONE
  HEMODIALYSIS
  PERITONEAL_DIALYSIS
}

enum TransplantStatus {
  NONE
  PRIOR   // Had transplant, now failed
  CURRENT // Functioning transplant
}

enum NyhaClass {
  CLASS_1
  CLASS_2
  CLASS_3
  CLASS_4
}

enum DiabetesType {
  NONE
  TYPE_1
  TYPE_2
}

enum AuditEntityType {
  PATIENT_PROFILE
  CARE_PLAN
}

enum ActorType {
  PATIENT
  CLINICIAN
  SYSTEM
}

// ============================================
// Slice 4: Device Integration (Withings)
// ============================================

model DeviceConnection {
  id             String   @id @default(uuid())
  patientId      String
  patient        Patient  @relation(fields: [patientId], references: [id])

  vendor         DeviceVendor             @default(WITHINGS)
  accessToken    String                   // Encrypted
  refreshToken   String                   // Encrypted
  tokenExpiresAt DateTime

  scope          String?                  // OAuth scopes granted
  withingsUserId String?                  // Withings user ID for API calls

  status         DeviceConnectionStatus   @default(ACTIVE)
  lastSyncAt     DateTime?
  lastSyncError  String?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([patientId, vendor])
  @@index([status, lastSyncAt])
  @@map("device_connections")
}

enum DeviceVendor {
  WITHINGS
}

enum DeviceConnectionStatus {
  ACTIVE
  EXPIRED     // Token expired, needs re-auth
  REVOKED     // User disconnected
  ERROR       // Persistent sync errors
}

// ============================================
// Slice 1 (Billing): Time Entry for RPM/CCM
// ============================================

model TimeEntry {
  id              String            @id @default(uuid())
  patientId       String
  patient         Patient           @relation(fields: [patientId], references: [id])
  clinicianId     String
  clinician       Clinician         @relation(fields: [clinicianId], references: [id])
  clinicId        String
  clinic          Clinic            @relation(fields: [clinicId], references: [id])

  entryDate       DateTime          @db.Date
  durationMinutes Int               // 1-120 minutes
  activity        TimeEntryActivity
  notes           String?

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([patientId, entryDate])
  @@index([clinicianId, entryDate])
  @@index([clinicId, entryDate])
  @@map("time_entries")
}

enum TimeEntryActivity {
  PATIENT_REVIEW      // Reviewing patient data, trends, alerts
  CARE_PLAN_UPDATE    // Updating care plan
  PHONE_CALL          // Patient/caregiver phone call
  COORDINATION        // Care coordination with other providers
  DOCUMENTATION       // Documenting patient encounter
  OTHER
}
